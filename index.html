<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Arabic MIDI Keyboard 2.0 by Zaher Alkaei</title>
    <style>
        body {
            background-color: #191a1b; /* Fallback for browsers that don't support background images */
            background-image: url('https://www.transparenttextures.com/patterns/asfalt-light.png'); /* Subtle pattern */
            color: white;
            font-family: 'Arial', sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
        }
        .key {
            display: inline-block;
            width: 40px;
            height: 200px;
            border: 1px solid black;
            margin: 2px;
            cursor: pointer;
            border-radius: 15px;
        }
        .white-key {
            background-color: white;
            position: relative;
        }
        .black-key {
            background-color: black;
            height: 120px;
            width: 30px;
            position: absolute;
            z-index: 1;
            margin-left: -15px;
            border-radius: 15px;
        }
        .key-container {
            position: relative;
            display: inline-block;
        }
        .pressed {
            background-color: yellow !important;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }
        .controls button, .controls select {
            margin: 5px;
            padding: 10px;
            border: 1px solid white;
            background-color: black;
            color: white;
            cursor: pointer;
            font-size: 16px;
            border-radius: 10px;
        }
        .controls button.active {
            background-color: lightgreen;
            color: black;
        }
        .note {
            margin-top: 5px;
        }
        #keyboard-container {
            border: none;
            padding: 20px;
            display: inline-block;
            margin-bottom: 30px;
        }
        #volume-container {
            margin-top: 20px;
            padding: 10px;
            background-color: transparent;
            display: inline-block;
            text-align: center;
        }
        #volume-slider, #tempo-slider, #drum-volume-slider {
            width: 300px;
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            background: orange;
            outline: none;
            opacity: 0.7;
            transition: opacity .2s;
        }
        #volume-slider:hover, #tempo-slider:hover, #drum-volume-slider:hover {
            opacity: 1;
        }
        #volume-slider::-webkit-slider-thumb, #tempo-slider::-webkit-slider-thumb, #drum-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: white;
            cursor: pointer;
            border-radius: 10px;
        }
        #volume-slider::-moz-range-thumb, #tempo-slider::-moz-range-thumb, #drum-volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: white;
            cursor: pointer;
            border-radius: 15px;
        }
        .slider-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .slider-label {
            margin-right: 10px;
        }
        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            margin-bottom: 10px;
        }
        .button-container .black-button {
            position: absolute;
            z-index: 1;
            border-radius: 10px;
        }
        .button-container .black-button[data-note="C#"] {
            left: 55px;
        }
        .button-container .black-button[data-note="D#"] {
            left: 148px;
        }
        .button-container .black-button[data-note="F#"] {
            left: 335px;
        }
        .button-container .black-button[data-note="G#"] {
            left: 418px;
        }
        .button-container .black-button[data-note="A#"] {
            left: 500px;
        }
        .button-container.lower-row {
            margin-bottom: 120px;
        }
        .about-button {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 10px;
            background-color: lightblue;
            color: black;
            cursor: pointer;
            font-size: 16px;
            border: none;
            border-radius: 10px;
        }
        .about-popout {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            color: black;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
        }
        .about-popout h2 {
            margin-top: 0;
        }
        .about-popout p {
            text-align: left;
        }
        .about-popout .close-button {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 10px;
        }
        #drum-pads {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin: 20px auto;
            max-width: 800px;
        }
        .drum-row {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        .drum-row label {
            width: 100px;
            text-align: right;
            margin-right: 10px;
        }
        .drum-pad {
            padding: 25px;
            background-color: #ccc;
            border: 1px solid #999;
            border-radius: 15px;
            cursor: pointer;
            margin: 2px;
        }
        .drum-pad.active {
            background-color: #ff8c00;
        }
        .drum-pad.current {
            background-color: #00ff00;
        }
        .progress-step {
            width: 30px;
            height: 10px;
            background-color: #333;
            margin: 2px;
        }
        .progress-step.current {
            background-color: #00ff00;
        }
        #effects {
            margin: 20px;
        }
        .effect-button {
            background-color: #555;
            color: #fff;
            padding: 10px;
            border-radius: 10px;
            margin: 5px;
            cursor: pointer;
        }
        .effect-button.active {
            background-color: #ff8c00;
        }
    </style>
</head>
<body>
    <button class="about-button" onclick="showAbout()">About</button>
    <div class="about-popout" id="aboutPopout">
        <h2>About the Arabic MIDI Keyboard 2.0</h2>
        <p>This project is a combination of the Arabic MIDI Keyboard and the Drum Machine, which were originally separate applications. It allows you to play music using a computer keyboard or a touchscreen, and create drum patterns with various sounds. It is designed to be used in modern browsers, such as Google Chrome or Mozilla Firefox.</p>
        
        <p><strong>New Features:</strong></p>
        <ul>
            <li>Merged the Arabic MIDI Keyboard and Drum Machine into a single application.</li>
            <li>Added the option to choose between 2 or 3 octaves for the keyboard.</li>
            <li>Included multiple sound options for the drum machine, such as standard, cajon, and electro.</li>
            <li>Introduced a hold button to the keyboard for sustained notes.</li>
        </ul>
        
        <p><strong>Drum Machine:</strong></p>
        <p>The drum machine allows you to create rhythmic patterns with a variety of sounds. You can choose from standard, cajon, and electro sounds, and customize the rhythm length and preset patterns.</p>
        
        <p><strong>Libraries Used:</strong></p>
        <ul>
            <li><strong>Web Audio API</strong>: For generating and controlling audio.</li>
            <li><strong>Tone.js</strong>: A framework built on the Web Audio API to simplify creating interactive music applications.</li>
        </ul>
        
        <p>For more information and to contribute, visit the <a href="https://github.com/zaheralkaei/thearabicmidikeyboardii" target="_blank">GitHub repository</a>.</p>
        <button class="close-button" onclick="hideAbout()">Close</button>
    </div>
    <h1>The Arabic MIDI Keyboard 2.0</h1>
    <p>by <a href="https://github.com/zaheralkaei" target="_blank" style="color: lightblue;">Zaher Alkaei</a></p>
    <div id="keyboard-container">
        <div id="keyboard">
            <!-- Keys will be generated by JavaScript -->
        </div>
    </div>
    <div class="controls">
        <div class="button-container lower-row">
            <button class="black-button" data-note="C#">Lower C#</button>
            <button class="black-button" data-note="D#">Lower D#</button>
            <button class="black-button" data-note="F#">Lower F#</button>
            <button class="black-button" data-note="G#">Lower G#</button>
            <button class="black-button" data-note="A#">Lower A#</button>
        </div>
        <div class="button-container">
            <button data-note="C">Lower C</button>
            <button data-note="D">Lower D</button>
            <button data-note="E">Lower E</button>
            <button data-note="F">Lower F</button>
            <button data-note="G">Lower G</button>
            <button data-note="A">Lower A</button>
            <button data-note="B">Lower B</button>
        </div>
    </div>
    <p>These two rows of buttons lower the pitch by a quarter tone.</p>
    <div class="controls">
        <select id="instrument-voice">
            <option value="sine">Piano</option>
            <option value="triangle">Strings</option>
            <option value="square">Harp</option>
            <option value="sawtooth">Synth</option>
            <option value="custom1">Flute</option>
            <option value="custom2">Organ</option>
            <option value="custom4">Bass Guitar</option>
        </select>
        <select id="octave-select">
            <option value="2">2 Octaves</option>
            <option value="3">3 Octaves</option>
        </select>
        <button id="toggle-reverb">Toggle Reverb</button>
        <button id="toggle-arpeggiator">Toggle Arpeggiator</button>
        <button id="toggle-hold">Toggle Hold</button>
    </div>
    <div id="volume-container">
        <div class="slider-container">
            <label for="volume-slider" class="slider-label">Volume (%)</label>
            <input type="range" id="volume-slider" min="0" max="100" value="50">
            <span id="volume-value">50%</span>
        </div>
        <div class="slider-container">
            <label for="tempo-slider" class="slider-label">Tempo (BPM)</label>
            <input type="range" id="tempo-slider" min="30" max="240" value="120">
            <span id="tempo-value">120 BPM</span>
        </div>
        <div class="slider-container">
            <label for="drum-volume-slider" class="slider-label">Drum Volume (%)</label>
            <input type="range" id="drum-volume-slider" min="0" max="100" value="50">
            <span id="drum-volume-value">50%</span>
        </div>
    </div>
    <div class="controls">
        <button id="play-stop">Play Drum Machine</button>
        <button id="reverb-button" class="effect-button">Reverb</button>
        <button id="distortion-button" class="effect-button">Distortion</button>
    </div>
    <div class="controls">
        <label for="length">Rhythm Length:</label>
        <select id="length">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12">12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
            <option value="16">16</option>
        </select>
        <label for="preset">Preset Rhythms:</label>
        <select id="preset">
            <option value="standard">Standard</option>
            <option value="samba">Samba</option>
            <option value="malfuf">Malfuf</option>
            <option value="karatchi">Karatchi</option>
            <option value="masmudi">Masmudi</option>
            <option value="thuraya">Thuraya</option>
            <option value="zaffa">Zaffa</option>
            <option value="katakofti">Katakofti</option>
            <option value="fox">Fox</option>
            <option value="hacha">Hacha</option>
            <option value="garagn">Garagn</option>
            <option value="jorjina">Jorjina</option>
            <option value="lalog">Lalog</option>
            <option value="leffa">Leffa</option>
            <option value="mokswadi">Mokswadi</option>
            <option value="waltz">Waltz</option>
            <option value="electro">Electro</option>
            <option value="techno">Techno</option>
            <option value="pop">Pop</option>
            <option value="rock">Rock</option>
            <option value="funk">Funk</option>
            <option value="house">House</option>
            <option value="jazz">Jazz</option>
            <option value="bossaNova">Bossa Nova</option>
            <option value="rumba">Rumba</option>
            <option value="sambaReggae">Samba Reggae</option>
            <option value="merengue">Merengue</option>
            <option value="sonCubano">Son Cubano</option>
            <option value="tango">Tango</option>
            <option value="progressive">Progressive</option>
            <option value="progressive2">Progressive 2</option>
            <option value="fiveEight">5/8</option>
            <option value="sevenEight">7/8</option>
            <option value="tenEight">10/8</option>
        </select>
        <label for="drum-sound">Drum Sound:</label>
        <select id="drum-sound">
            <option value="standard">Standard</option>
            <option value="cajon">Cajon</option>
            <option value="electro">Electro</option>
        </select>
    </div>
    <div id="drum-pads">
        <!-- Drum pads will be generated here by JavaScript -->
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
    <script>
        const noteFrequencies = {
            'C4': 261.63,
            'C#4': 277.18,
            'D4': 293.66,
            'D#4': 311.13,
            'E4': 329.63,
            'F4': 349.23,
            'F#4': 369.99,
            'G4': 392.00,
            'G#4': 415.30,
            'A4': 440.00,
            'A#4': 466.16,
            'B4': 493.88,
            'C5': 523.25,
            'C#5': 554.37,
            'D5': 587.33,
            'D#5': 622.25,
            'E5': 659.25,
            'F5': 698.46,
            'F#5': 739.99,
            'G5': 783.99,
            'G#5': 830.61,
            'A5': 880.00,
            'A#5': 932.33,
            'B5': 987.77,
            'C6': 1046.50,
            'C#6': 1108.73,
            'D6': 1174.66,
            'D#6': 1244.51,
            'E6': 1318.51,
            'F6': 1396.91,
            'F#6': 1479.98,
            'G6': 1567.98,
            'G#6': 1661.22,
            'A6': 1760.00,
            'A#6': 1864.66,
            'B6': 1975.53,
            'C7': 2093.00
        };

        const keyMap = {
            'q': 'C4', '2': 'C#4', 'w': 'D4', '3': 'D#4', 'e': 'E4', 'r': 'F4', '5': 'F#4', 't': 'G4', '6': 'G#4', 'z': 'A4', '7': 'A#4', 'u': 'B4', 'i': 'C5', '9': 'C#5', 'o': 'D5', '0': 'D#5', 'p': 'E5', '[': 'F5', '=': 'F#5', ']': 'G5', '\\': 'G#5',
            'y': 'C5', 's': 'C#5', 'x': 'D5', 'd': 'D#5', 'c': 'E5', 'v': 'F5', 'g': 'F#5', 'b': 'G5', 'h': 'G#5', 'n': 'A5', 'j': 'A#5', 'm': 'B5', ',': 'C6', 'l': 'C#6', '.': 'D6', ';': 'D#6', '/': 'E6'
        };

        const context = new (window.AudioContext || window.webkitAudioContext)();
        const keys = {};
        const pitchAdjustments = {
            'C': 0,
            'C#': 0,
            'D': 0,
            'D#': 0,
            'E': 0,
            'F': 0,
            'F#': 0,
            'G': 0,
            'G#': 0,
            'A': 0,
            'A#': 0,
            'B': 0
        };
        let currentVoice = 'sine';
        const activeOscillators = {};
        let reverbNode = null;
        let isReverbOn = false;
        let isArpeggiatorOn = false;
        let arpeggiatorInterval = null;
        let arpeggiatorNotes = [];
        let arpeggiatorIndex = 0;
        let masterGainNode = context.createGain();
        masterGainNode.connect(context.destination);
        let velocity = 64;
        let tempo = 120;
        let hold = false;
        let drumVolume = 50;

        // Function to create a reverb effect
        function createReverb() {
            const convolver = context.createConvolver();
            const noiseBuffer = context.createBuffer(2, context.sampleRate * 3, context.sampleRate);
            const left = noiseBuffer.getChannelData(0);
            const right = noiseBuffer.getChannelData(1);
            for (let i = 0; i < noiseBuffer.length; i++) {
                left[i] = Math.random() * 2 - 1;
                right[i] = Math.random() * 2 - 1;
            }
            convolver.buffer = noiseBuffer;
            return convolver;
        }

        // Function to create an ADSR envelope
        function applyADSR(gainNode, duration, attack = 0.01, decay = 0.01, sustain = 0.7, release = 0.01) {
            const now = context.currentTime;
            gainNode.gain.cancelScheduledValues(now);
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(velocity / 127, now + attack);
            gainNode.gain.linearRampToValueAtTime((velocity / 127) * sustain, now + attack + decay);
            gainNode.gain.setValueAtTime((velocity / 127) * sustain, now + duration - release);
            gainNode.gain.linearRampToValueAtTime(0, now + duration);
        }

        // Function to play a frequency with the current voice and add an envelope
        function playFrequency(note, frequency, duration = 0.1) {
            const oscillator = context.createOscillator();
            const gainNode = context.createGain();

            switch (currentVoice) {
                case 'sine':  // Piano
                    oscillator.type = 'sine';
                    break;
                case 'triangle':  // Strings
                    oscillator.type = 'triangle';
                    break;
                case 'square':  // Harp
                    oscillator.type = 'square';
                    break;
                case 'sawtooth':  // Synth
                    oscillator.type = 'sawtooth';
                    break;
                case 'custom1':  // Flute
                    oscillator.type = 'sine';
                    applyADSR(gainNode, duration, 0.01, 0.02, 0.5, 0.03);
                    break;
                case 'custom2':  // Organ
                    oscillator.type = 'square';
                    applyADSR(gainNode, duration, 0.02, 0.02, 0.8, 0.02);
                    break;
                case 'custom4':  // Bass Guitar
                    oscillator.type = 'sawtooth';
                    const filter = context.createBiquadFilter();
                    filter.type = 'lowpass';
                    filter.frequency.setValueAtTime(500, context.currentTime);
                    oscillator.connect(filter).connect(gainNode);
                    break;
                default:
                    oscillator.type = currentVoice;
                    break;
            }

            if (currentVoice !== 'custom3') {
                oscillator.frequency.setValueAtTime(frequency, context.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(masterGainNode);
                if (isReverbOn) {
                    if (!reverbNode) {
                        reverbNode = createReverb();
                    }
                    masterGainNode.connect(reverbNode);
                    reverbNode.connect(context.destination);
                } else {
                    masterGainNode.connect(context.destination);
                }

                applyADSR(gainNode, duration);
                oscillator.start();
                if (!hold) {
                    oscillator.stop(context.currentTime + duration);
                }
                if (!activeOscillators[note]) {
                    activeOscillators[note] = [];
                }
                activeOscillators[note].push(oscillator);
            }
        }

        // Function to stop playing a note
        function stopFrequency(note) {
            if (activeOscillators[note]) {
                activeOscillators[note].forEach(oscillator => oscillator.stop());
                activeOscillators[note] = [];
            }
        }

        // Function to adjust the frequency based on pitch adjustments
        function adjustFrequency(note, frequency) {
            const baseNote = note.slice(0, -1);  // Extract the base note without the octave number
            const adjustment = pitchAdjustments[baseNote];
            return frequency * Math.pow(2, adjustment / 1200);
        }

        // Function to create a key element
        function createKey(note, frequency, isBlack) {
            const key = document.createElement('div');
            key.className = `key ${isBlack ? 'black-key' : 'white-key'}`;
            key.addEventListener('mousedown', () => handleKeyDown({ key: note }));
            key.addEventListener('mouseup', () => handleKeyUp({ key: note }));
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleKeyDown({ key: note });
            });
            key.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleKeyUp({ key: note });
            });
            key.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                handleKeyUp({ key: note });
            });
            keys[note] = key;
            return key;
        }

        // Function to generate the keyboard
        function generateKeyboard() {
            const keyboard = document.getElementById('keyboard');
            keyboard.innerHTML = ''; // Clear the keyboard container before generating
            const octaveCount = parseInt(document.getElementById('octave-select').value);
            const notes = Object.keys(noteFrequencies).slice(0, octaveCount * 12);

            notes.forEach(note => {
                const isBlack = note.includes('#');
                const keyContainer = document.createElement('div');
                keyContainer.className = 'key-container';

                const key = createKey(note, noteFrequencies[note], isBlack);
                keyContainer.appendChild(key);

                if (!isBlack) {
                    keyboard.appendChild(keyContainer);
                } else {
                    const previousKeyContainer = keyboard.lastElementChild;
                    if (previousKeyContainer) {
                        previousKeyContainer.appendChild(key);
                    }
                }
            });
        }
        const pressedKeys = new Set();
        // Event handler for keydown events
        function handleKeyDown(event) {
            const note = keyMap[event.key] || event.key;
            if (note && keys[note] && !pressedKeys[event.key]) {
                pressedKeys[event.key] = true;
                const adjustedFrequency = adjustFrequency(note, noteFrequencies[note]);
                if (isArpeggiatorOn) {
                    if (!arpeggiatorNotes.some(n => n.note === note)) {
                        arpeggiatorNotes.push({ note, adjustedFrequency });
                    } else {
                        arpeggiatorNotes = arpeggiatorNotes.filter(n => n.note !== note);
                        stopFrequency(note);
                    }
                } else {
                    if (hold && keys[note].classList.contains('pressed')) {
                        stopFrequency(note);
                        keys[note].classList.remove('pressed');
                    } else {
                        keys[note].classList.add('pressed');
                        playFrequency(note, adjustedFrequency, hold ? 9999 : 2); // Hold effect
                    }
                }
            }
        }

        function handleKeyUp(event) {
            const note = keyMap[event.key] || event.key;
            if (note && keys[note]) {
                if (!hold) {
                    stopFrequency(note);
                    keys[note].classList.remove('pressed');
                }
                pressedKeys[event.key] = false;
            }
        }

        // Event handler for pitch adjustment button clicks
        function handleButtonClick(event) {
            const note = event.target.getAttribute('data-note');
            if (note) {
                if (pitchAdjustments[note] === 0) {
                    pitchAdjustments[note] = -50;
                    event.target.classList.add('active');
                } else {
                    pitchAdjustments[note] = 0;
                    event.target.classList.remove('active');
                }
            }
        }

        // Event handler for changing the instrument voice
        function handleVoiceChange(event) {
            currentVoice = event.target.value;
        }

        // Toggle reverb effect
        function toggleReverb() {
            isReverbOn = !isReverbOn;
            document.getElementById('toggle-reverb').classList.toggle('active', isReverbOn);
        }

        // Toggle arpeggiator
        function toggleArpeggiator() {
            isArpeggiatorOn = !isArpeggiatorOn;
            if (isArpeggiatorOn) {
                clearInterval(arpeggiatorInterval); // Clear existing interval
                arpeggiatorInterval = setInterval(() => {
                    if (arpeggiatorNotes.length > 0) {
                        const noteInfo = arpeggiatorNotes[arpeggiatorIndex];
                        playFrequency(noteInfo.note, noteInfo.adjustedFrequency);
                        updateKeyColor(noteInfo.note);
                        arpeggiatorIndex = (arpeggiatorIndex + 1) % arpeggiatorNotes.length;
                    }
                }, 60000 / (tempo / 2) / 4); // Adjust the interval for the arpeggiator speed
            } else {
                clearInterval(arpeggiatorInterval);
                arpeggiatorNotes = [];
                arpeggiatorIndex = 0;
                resetKeyColors();
            }
            document.getElementById('toggle-arpeggiator').classList.toggle('active', isArpeggiatorOn);
        }

        // Update key color
        function updateKeyColor(note) {
            keys[note].classList.add('pressed');
            setTimeout(() => {
                keys[note].classList.remove('pressed');
            }, 100); // Match this duration with the note duration
        }

        // Reset all key colors
        function resetKeyColors() {
            Object.keys(keys).forEach(note => {
                keys[note].classList.remove('pressed');
            });
        }

        // Toggle hold effect
        function toggleHold() {
            hold = !hold;
            if (!hold) {
                Object.keys(keys).forEach(note => {
                    stopFrequency(note);
                    keys[note].classList.remove('pressed');
                });
            }
            document.getElementById('toggle-hold').classList.toggle('active', hold);
        }

        // Event handler for changing the volume
        function handleVolumeChange(event) {
            const volume = event.target.value;
            masterGainNode.gain.setValueAtTime(volume / 100, context.currentTime);
            document.getElementById('volume-value').innerText = `${volume}%`;
        }

        // Event handler for changing the tempo
        function handleTempoChange(event) {
            tempo = event.target.value;
            document.getElementById('tempo-value').innerText = `${tempo} BPM`;
            if (isArpeggiatorOn) {
                clearInterval(arpeggiatorInterval); // Clear existing interval
                arpeggiatorInterval = setInterval(() => {
                    if (arpeggiatorNotes.length > 0) {
                        const noteInfo = arpeggiatorNotes[arpeggiatorIndex];
                        playFrequency(noteInfo.note, noteInfo.adjustedFrequency);
                        updateKeyColor(noteInfo.note);
                        arpeggiatorIndex = (arpeggiatorIndex + 1) % arpeggiatorNotes.length;
                    }
                }, 60000 / (tempo / 2) / 4); // Adjust the interval for the arpeggiator speed
            }
            Tone.Transport.bpm.value = tempo;
        }

        // Event handler for changing the drum volume
        function handleDrumVolumeChange(event) {
            drumVolume = event.target.value;
            drumEffectChain.gain.setValueAtTime(drumVolume / 100, Tone.context.currentTime);
            document.getElementById('drum-volume-value').innerText = `${drumVolume}%`;
        }

        function showAbout() {
            document.getElementById('aboutPopout').style.display = 'block';
        }

        function hideAbout() {
            document.getElementById('aboutPopout').style.display = 'none';
        }

        // Initialize the application
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);
        document.querySelectorAll('.controls button[data-note]').forEach(button => {
            button.addEventListener('click', handleButtonClick);
        });
        document.getElementById('instrument-voice').addEventListener('change', handleVoiceChange);
        document.getElementById('octave-select').addEventListener('change', generateKeyboard);
        document.getElementById('toggle-reverb').addEventListener('click', toggleReverb);
        document.getElementById('toggle-arpeggiator').addEventListener('click', toggleArpeggiator);
        document.getElementById('toggle-hold').addEventListener('click', toggleHold);
        document.getElementById('volume-slider').addEventListener('input', handleVolumeChange);
        document.getElementById('tempo-slider').addEventListener('input', handleTempoChange);
        document.getElementById('drum-volume-slider').addEventListener('input', handleDrumVolumeChange);

        generateKeyboard();

        // Drum machine implementation
        const drumPadsContainer = document.getElementById('drum-pads');
        const drumEffectChain = new Tone.Gain().toDestination();
        const drumReverb = new Tone.Reverb(2).toDestination();
        const drumDistortion = new Tone.Distortion(0.4).toDestination();
        let currentDrumPreset = 'standard';
        let currentSynths = {};
        let rhythmLength = parseInt(document.getElementById('length').value);
        let isPlaying = false;

        // Define the sounds to be used and the initial state
        const sounds = ['hihat', 'snare', 'kick'];
        const synths = {
            standard: {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.05,
                    octaves: 4, // Increase octaves for a punchier sound
                    oscillator: { type: 'sine' },
                    envelope: { attack: 0.001, decay: 0.2, sustain: 0.1, release: 0.2, attackCurve: 'exponential' } // Adjusted sustain
                }).connect(drumEffectChain),
                hihat: new Tone.MetalSynth({
                    frequency: 600, // Higher frequency for a sharper sound
                    envelope: { attack: 0.001, decay: 0.05, release: 0.05 }, // Shorter decay and release for more rhythm
                    harmonicity: 8.5, // Increase harmonicity
                    modulationIndex: 50, // Increase modulation index
                    resonance: 8000, // Higher resonance
                    octaves: 2 // Increase octaves for brighter sound
                }).connect(drumEffectChain),
                snare: new Tone.NoiseSynth({
                    noise: { type: 'white' },
                    envelope: { attack: 0.001, decay: 0.1, sustain: 0.1, release: 0.1 } // Adjusted decay and release
                }).connect(drumEffectChain)
            },
            cajon: {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.08,
                    octaves: 1.5,
                    oscillator: { type: 'triangle' },
                    envelope: { attack: 0.002, decay: 0.5, sustain: 0, release: 0.4 }
                }).connect(drumEffectChain),
                hihat: new Tone.MetalSynth({
                    frequency: 150, // Lower frequency for a more wooden sound
                    envelope: { attack: 0.02, decay: 0.3, release: 0.3 }, // Adjusted envelope
                    harmonicity: 3, // Lower harmonicity
                    modulationIndex: 10, // Lower modulation index
                    resonance: 2000, // Lower resonance
                    octaves: 0.5 // Lower octaves for a softer sound
                }).connect(drumEffectChain),
                snare: new Tone.NoiseSynth({
                    noise: { type: 'brown' }, // Use brown noise for a deeper sound
                    envelope: { attack: 0.02, decay: 0.2, sustain: 0.1, release: 0.2 } // Adjusted envelope
                }).connect(drumEffectChain)
            },
            electro: {
                kick: new Tone.MembraneSynth({
                    pitchDecay: 0.1, // Longer pitch decay
                    octaves: 2, // Increase octaves for a more resonant sound
                    oscillator: { type: 'sawtooth' },
                    envelope: { attack: 0.001, decay: 0.5, sustain: 0.2, release: 0.5 } // Adjusted envelope
                }).connect(drumEffectChain),
                hihat: new Tone.MetalSynth({
                    frequency: 250, // Adjusted frequency
                    envelope: { attack: 0.02, decay: 0.5, release: 0.5 }, // Adjusted envelope
                    harmonicity: 7, // Adjusted harmonicity
                    modulationIndex: 25, // Adjusted modulation index
                    resonance: 4000, // Adjusted resonance
                    octaves: 1.5 // Adjusted octaves
                }).connect(drumEffectChain),
                snare: new Tone.NoiseSynth({
                    noise: { type: 'pink' }, // Use pink noise for a richer sound
                    envelope: { attack: 0.03, decay: 0.3, sustain: 0.2, release: 0.3 } // Adjusted envelope
                }).connect(drumEffectChain)
            }
        };

        currentSynths = synths[currentDrumPreset];

        // Set the initial tempo and volume
        Tone.Transport.bpm.value = tempo;
        drumEffectChain.gain.setValueAtTime(drumVolume / 100, Tone.context.currentTime);

        // Function to create the drum pads based on the rhythm length and sounds
        function createDrumPads() {
            drumPadsContainer.innerHTML = '';
            sounds.forEach(sound => {
                const row = document.createElement('div');
                row.classList.add('drum-row');
                const label = document.createElement('label');
                label.textContent = sound.charAt(0).toUpperCase() + sound.slice(1);
                row.appendChild(label);
                for (let i = 0; i < rhythmLength; i++) {
                    const pad = document.createElement('div');
                    pad.classList.add('drum-pad');
                    pad.dataset.sound = sound;
                    pad.dataset.step = i;
                    pad.addEventListener('click', () => {
                        pad.classList.toggle('active');
                    });
                    row.appendChild(pad);
                }
                drumPadsContainer.appendChild(row);
            });
        }

        // Function to create the progress row based on the rhythm length
        function createProgressRow() {
            const progressRow = document.getElementById('progress-row');
            progressRow.innerHTML = '';
            for (let i = 0; i < rhythmLength; i++) {
                const step = document.createElement('div');
                step.classList.add('progress-step');
                step.dataset.step = i;
                progressRow.appendChild(step);
            }
        }

        // Function to play the rhythm
        function playRhythm() {
            let step = 0;
            Tone.Transport.scheduleRepeat(time => {
                const currentPads = document.querySelectorAll(`.drum-pad[data-step="${step}"]`);
                const currentSteps = document.querySelectorAll(`.progress-step[data-step="${step}"]`);
                document.querySelectorAll('.drum-pad').forEach(pad => pad.classList.remove('current'));
                document.querySelectorAll('.progress-step').forEach(step => step.classList.remove('current'));
                currentPads.forEach(pad => {
                    pad.classList.add('current');
                    if (pad.classList.contains('active')) {
                        if (pad.dataset.sound === 'snare') {
                            currentSynths[pad.dataset.sound].triggerAttackRelease("8n", time);
                        } else {
                            currentSynths[pad.dataset.sound].triggerAttackRelease("C3", "8n", time);
                        }
                    }
                });
                currentSteps.forEach(step => {
                    step.classList.add('current');
                });
                step = (step + 1) % rhythmLength;
            }, "8n");
            Tone.Transport.start();
        }

        // Function to stop the rhythm
        function stopRhythm() {
            Tone.Transport.stop();
            Tone.Transport.cancel();
            document.querySelectorAll('.drum-pad').forEach(pad => pad.classList.remove('current'));
            document.querySelectorAll('.progress-step').forEach(step => step.classList.remove('current'));
        }

        // Function to toggle play/stop button
        function togglePlayStop() {
            if (isPlaying) {
                stopRhythm();
                document.getElementById('play-stop').textContent = 'Play Drum Machine';
            } else {
                playRhythm();
                document.getElementById('play-stop').textContent = 'Stop Drum Machine';
            }
            isPlaying = !isPlaying;
        }

        // Function to load preset rhythms
        function loadPreset(preset) {
            const presets = {
                standard: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [2, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                samba: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['hihat', [0, 2, 4, 6]],
                        ['snare', [1, 3, 5, 7]]
                    ]
                },
                malfuf: {
                    length: 4,
                    patterns: [
                        ['kick', [0, 1, 2, 3]],
                        ['hihat', [1, 3]],
                        ['snare', [2]]
                    ]
                },
                karatchi: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [2, 6]],
                        ['snare', [1, 5]]
                    ]
                },
                masmudi: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 5, 7]],
                        ['hihat', [1, 3, 6]],
                        ['snare', [4]]
                    ]
                },
                thuraya: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 5, 7]],
                        ['hihat', [1, 4, 6]],
                        ['snare', [2, 6]]
                    ]
                },
                zaffa: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['hihat', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['snare', [2, 4, 6]]
                    ]
                },
                katakofti: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 5]],
                        ['hihat', [1, 4, 6]],
                        ['snare', [2, 7]]
                    ]
                },
                fox: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                hacha: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 5, 7]],
                        ['hihat', [1, 3, 6]],
                        ['snare', [4]]
                    ]
                },
                garagn: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 6]],
                        ['hihat', [1, 4, 7]],
                        ['snare', [2, 5]]
                    ]
                },
                jorjina: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [2, 6]],
                        ['snare', [1, 5]]
                    ]
                },
                lalog: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 5]],
                        ['hihat', [1, 4, 6]],
                        ['snare', [2, 7]]
                    ]
                },
                leffa: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 5, 7]],
                        ['hihat', [1, 3, 6]],
                        ['snare', [4]]
                    ]
                },
                mokswadi: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 6]],
                        ['hihat', [1, 4, 7]],
                        ['snare', [2, 5]]
                    ]
                },
                waltz: {
                    length: 6,
                    patterns: [
                        ['kick', [0, 3]],
                        ['hihat', [1, 2, 4, 5]],
                        ['snare', [2, 5]]
                    ]
                },
                electro: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['hihat', [2, 6]],
                        ['snare', [4]]
                    ]
                },
                techno: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [4]]
                    ]
                },
                pop: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [2, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                rock: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                funk: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 5]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 4, 6]]
                    ]
                },
                house: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                jazz: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 5]],
                        ['hihat', [1, 2, 3, 4, 6, 7]],
                        ['snare', [4]]
                    ]
                },
                bossaNova: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 3, 6]],
                        ['hihat', [2, 5, 7]],
                        ['snare', [4]]
                    ]
                },
                rumba: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 4]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                sambaReggae: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                merengue: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                sonCubano: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                tango: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 2, 4, 6]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 6]]
                    ]
                },
                progressive: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 2, 3, 4, 5, 6, 7]],
                        ['hihat', [2, 4, 6]],
                        ['snare', [3, 7]]
                    ]
                },
                progressive2: {
                    length: 8,
                    patterns: [
                        ['kick', [0, 1, 3, 5, 7]],
                        ['hihat', [1, 3, 5, 7]],
                        ['snare', [2, 4, 6]]
                    ]
                },
                fiveEight: {
                    length: 5,
                    patterns: [
                        ['kick', [0, 2]],
                        ['hihat', [1, 3, 4]],
                        ['snare', [2]]
                    ]
                },
                sevenEight: {
                    length: 7,
                    patterns: [
                        ['kick', [0, 2, 4]],
                        ['hihat', [1, 3, 5, 6]],
                        ['snare', [3]]
                    ]
                },
                tenEight: {
                    length: 10,
                    patterns: [
                        ['kick', [0, 3, 7]],
                        ['hihat', [1, 4, 8, 9]],
                        ['snare', [5]]
                    ]
                }
            };

            const selectedPreset = presets[preset];
            if (selectedPreset) {
                rhythmLength = selectedPreset.length;
                document.getElementById('length').value = rhythmLength;
                createDrumPads();
                selectedPreset.patterns.forEach(([sound, steps]) => {
                    steps.forEach(step => {
                        const pad = document.querySelector(`.drum-pad[data-sound="${sound}"][data-step="${step}"]`);
                        if (pad) {
                            pad.classList.add('active');
                        }
                    });
                });
            }
        }

        // Function to handle drum sound change
        function handleDrumSoundChange(event) {
            const selectedSound = event.target.value;
            currentDrumPreset = selectedSound;
            currentSynths = synths[currentDrumPreset];
        }

        // Function to toggle effects on and off
        function toggleEffect(button, effect, isActive) {
            if (isActive) {
                drumEffectChain.disconnect(effect);
                button.classList.remove('active');
            } else {
                drumEffectChain.connect(effect);
                button.classList.add('active');
            }
            return !isActive;
        }

        let isReverbActive = false;
        let isDistortionActive = false;

        document.getElementById('reverb-button').addEventListener('click', () => {
            isReverbActive = toggleEffect(document.getElementById('reverb-button'), drumReverb, isReverbActive);
        });

        document.getElementById('distortion-button').addEventListener('click', () => {
            isDistortionActive = toggleEffect(document.getElementById('distortion-button'), drumDistortion, isDistortionActive);
        });

        // Event listeners for user interactions
        document.getElementById('length').addEventListener('change', (e) => {
            rhythmLength = parseInt(e.target.value);
            createDrumPads();
            if (isPlaying) {
                stopRhythm();
                playRhythm();
            }
        });

        document.getElementById('play-stop').addEventListener('click', togglePlayStop);
        document.getElementById('preset').addEventListener('change', (e) => {
            loadPreset(e.target.value);
        });
        document.getElementById('drum-sound').addEventListener('change', handleDrumSoundChange);

        // Initialize the drum machine with default settings
        createDrumPads();
        loadPreset('standard');
    </script>
</body>
</html>
